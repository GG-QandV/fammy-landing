# Технический отчет: Проблема Supabase при сборке (Build-time Issue)

Этот документ содержит детали ошибки, выявленной при выполнении команды `npm run build` в папке `new_design`.

## 1. Суть проблемы

При сборке Next.js пытается инициализировать модули для статической генерации или проверки типов. Модуль `@/lib/supabaseAdmin.ts` инициализирует `createClient` и требует наличия переменных окружения `NEXT_PUBLIC_SUPABASE_URL` и `SUPABASE_SERVICE_ROLE_KEY`. Если они отсутствуют в окружении (даже если роут помечен `force-dynamic`), процесс сборки прерывается.

## 2. Список затронутых файлов

Ниже перечислены файлы, которые либо вызывают ошибку напрямую, либо импортируют проблемный модуль:

- **Ядро инициализации**:
  
  - `new_design/lib/supabaseAdmin.ts` — Основная точка отказа. Требует ключи сервисной роли.
  - `new_design/lib/supabase.ts` — Требует публичные ключи.

- **API Роуты (Backend)**:
  
  - `new_design/app/api/f1/analyze/route.ts` — Импортирует `supabaseAdmin` для работы с БД.
  - `new_design/app/api/f2/check/route.ts` — Импортирует `supabaseAdmin` для проверки безопасности.
  - `new_design/app/api/donate/route.ts` — Импортирует `supabaseAdmin` для записи транзакций.

- **Компоненты (Frontend)**:
  
  - Любой серверный компонент, который может импортировать `lib/supabaseAdmin` напрямую.

## 3. Команды для проверки и воспроизведения

Для тестирования в отдельном терминале (в папке `new_design`):

1. **Воспроизведение ошибки сборки**:
   
   ```bash
   npm run build
   ```
   
   *Ожидаемый результат: Ошибка `supabaseUrl is required`.*

2. **Проверка работы в режиме разработки**:
   *Примечание: Требуется наличие файла `.env.local` с валидными ключами.*
   
   ```bash
   npm run dev
   ```

3. **Обходной путь для успешной сборки (Build Hack)**:
   Если нужно собрать проект без живых ключей (просто проверить типы и структуру):
   
   ```bash
   NEXT_PUBLIC_SUPABASE_URL=https://dummy.supabase.co SUPABASE_SERVICE_ROLE_KEY=dummy npm run build
   ```

## 4. Рекомендации по исправлению

1. **CI/CD**: Добавить указанные переменные в секреты вашего репозитория или окружения сборки.
2. **Runtime Check**: Обновить `supabaseAdmin.ts`, чтобы он не падал сразу при импорте, а проверял наличие ключей только при вызове функций (ленивая инициализация).
3. **Validation**: Сейчас в роутах добавлена директива `export const dynamic = 'force-dynamic'`, что правильно для runtime, но не решает проблему инициализации модуля на этапе сборки.

---

**Статус**: Информация готова для инженера бэкенда.
